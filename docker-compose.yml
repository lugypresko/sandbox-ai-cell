version: '3.8'

services:
  app-service:
    build:
      context: .
      dockerfile: Dockerfile.sandbox
    environment:
      - ROLE=app
      - SERVICE_NAME=user-facing
      - DEPENDENCY_URL=http://dependency-api:8000
      - LATENCY_MS=50
    ports:
      - "8001:8000"
    depends_on:
      - dependency-api

  dependency-api:
    build:
      context: .
      dockerfile: Dockerfile.sandbox
    environment:
      - ROLE=dependency
      - SERVICE_NAME=downstream-db
      - LATENCY_MS=100

  otel-collector:
    image: otel/opentelemetry-collector:latest
    volumes:
      - ./sandbox/otel-config.yaml:/etc/otel-config.yaml
    command: ["--config=/etc/otel-config.yaml"]

  ai-cell-engine:
    build:
      context: .
      dockerfile: Dockerfile.engine
    volumes:
      - ./src:/app/src
      - ./sandbox/artifacts:/var/log/ai-cell
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - otel-collector
