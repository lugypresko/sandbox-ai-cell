version: '3.8'

services:
  # המציאות: השירותים שיוצרים נתונים
  app-service:
    build: 
      context: .
      dockerfile: Dockerfile.sandbox
    environment:
      - SERVICE_NAME=user-facing
      - DEPENDENCY_URL=http://dependency-api:8000
    ports:
      - "8001:8000"

  dependency-api:
    build:
      context: .
      dockerfile: Dockerfile.sandbox
    environment:
      - SERVICE_NAME=downstream-db
    # כאן נוכל להזריק השהיות (Drift) דרך סקריפטים חיצוניים

  # הצנרת: OTel Collector
  otel-collector:
    image: otel/opentelemetry-collector:latest
    volumes:
      - ./sandbox/otel-config.yaml:/etc/otel-config.yaml
    command: ["--config=/etc/otel-config.yaml"]

  # המוח: AI-CELL Engine
  ai-cell-engine:
    build:
      context: .
      dockerfile: Dockerfile.engine
    volumes:
      - ./src:/app/src
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4317
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - otel-collector